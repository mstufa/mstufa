<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Øª ØµÙˆÙÙŠ Ø§Ù„ÙˆØ±Ø¯ÙŠ ğŸŒ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        
        body {
            margin: 0; padding: 0; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            overflow: hidden;
        }

        /* ÙƒØ§Ø±Øª Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .chat-card {
            width: 100%; max-width: 450px; height: 95vh;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 25px; 
            border: 2px solid rgba(255, 255, 255, 0.8);
            display: flex; flex-direction: column;
            box-shadow: 0 10px 40px rgba(255, 105, 180, 0.2);
            position: relative; overflow: hidden;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØºØ±Ù Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .rooms-bar {
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            display: flex; gap: 10px; overflow-x: auto;
            border-bottom: 1px solid rgba(255, 182, 193, 0.3);
            scrollbar-width: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· */
        }
        .room-btn {
            padding: 8px 16px; border: none; border-radius: 20px;
            background: #fff0f5; color: #ff6b6b;
            font-weight: bold; cursor: pointer; white-space: nowrap;
            transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .room-btn.active {
            background: #ff6b6b; color: white;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);
        }

        /* Ø±Ø£Ø³ Ø§Ù„Ø´Ø§Øª */
        .chat-header {
            padding: 15px; text-align: center;
            background: rgba(255, 255, 255, 0.5);
        }
        .chat-header h2 {
            margin: 0; color: #d63384; font-size: 18px;
        }
        .current-room-name {
            font-size: 12px; color: #666; margin-top: 5px;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .chat-body {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        .message-row { display: flex; align-items: flex-end; gap: 10px; }
        
        .msg-content {
            padding: 12px 18px; border-radius: 20px; font-size: 15px;
            line-height: 1.5; position: relative;
            max-width: 80%; word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Ø±Ø³Ø§Ù„ØªÙŠ (ÙŠÙ…ÙŠÙ† - ÙˆØ±Ø¯ÙŠ ØºØ§Ù…Ù‚) */
        .mine { flex-direction: row-reverse; }
        .mine .msg-content {
            background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
            color: white; border-bottom-right-radius: 4px;
        }

        /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† (ÙŠØ³Ø§Ø± - Ø£Ø¨ÙŠØ¶) */
        .theirs .msg-content {
            background: white; color: #555;
            border-bottom-left-radius: 4px;
        }

        .msg-avatar {
            width: 35px; height: 35px; border-radius: 50%;
            background-size: cover; background-position: center;
            background-color: #fff; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© */
        .chat-footer {
            padding: 15px; background: rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; gap: 10px;
        }
        input {
            flex: 1; padding: 15px; border-radius: 30px; border: 2px solid #ffebf0;
            background: white; color: #333; outline: none; transition: 0.3s;
        }
        input:focus { border-color: #ff758c; }
        
        .send-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
            color: white; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(255, 117, 140, 0.4);
        }

        /* Ù†Ø§ÙØ°Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø®Ø§ØµØ© */
        .modal {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 20px; width: 80%; text-align: center;
        }
        .modal input { width: 100%; margin: 15px 0; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <div class="chat-card">
        <div class="rooms-bar">
            <button class="room-btn active" onclick="switchRoom('general', this)">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ğŸ </button>
            <button class="room-btn" onclick="switchRoom('friends', this)">ØªØ¹Ø§Ø±Ù ğŸ¤</button>
            <button class="room-btn" onclick="switchRoom('girls', this)">Ø¨Ù†Ø§Øª ÙˆØ¨Ø³ ğŸ€</button>
            <button class="room-btn" onclick="openPrivateModal()">ØºØ±ÙØ© Ø®Ø§ØµØ© ğŸ”’</button>
        </div>

        <div class="chat-header">
            <h2>ğŸŒ¸ Ø´Ø§Øª ØµÙˆÙÙŠ Ø§Ù„ÙˆØ±Ø¯ÙŠ ğŸŒ¸</h2>
            <div class="current-room-name" id="roomTitle">Ø§Ù„ØºØ±ÙØ©: Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        </div>

        <div class="chat-body" id="chatBox">
            </div>

        <div class="chat-footer">
            <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø±Ø³Ø§Ù„Ø© Ù„Ø·ÙŠÙØ©..." onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendMsg()">â¤</button>
        </div>

        <div class="modal" id="privateModal">
            <div class="modal-content">
                <h3>Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ© Ø®Ø§ØµØ© ğŸ”’</h3>
                <p>Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ù„Ø§Ù‹: 1234) ÙˆØ´Ø§Ø±Ùƒ Ø§Ù„Ø§Ø³Ù… Ù…Ø¹ ØµØ¯ÙŠÙ‚Ùƒ ÙÙ‚Ø·.</p>
                <input type="text" id="privateRoomInput" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø³Ø±ÙŠØ©">
                <button class="room-btn active" onclick="joinPrivateRoom()">Ø¯Ø®ÙˆÙ„</button>
                <button class="room-btn" onclick="closeModal()" style="background:#eee; color:#666">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTIGaJkfT2sM7cOGcKGeD6c-rmpozCD-w",
            authDomain: "mstufa-1f409.firebaseapp.com",
            databaseURL: "https://mstufa-1f409-default-rtdb.firebaseio.com",
            projectId: "mstufa-1f409",
            storageBucket: "mstufa-1f409.firebasestorage.app",
            messagingSenderId: "638217767100",
            appId: "1:638217767100:web:4bec44dafble8c4e37a8b9",
            measurementId: "G-LZPDYT2TZB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let currentRoom = 'general';
        let messagesRef = ref(db, 'rooms/general/messages');
        let myId = localStorage.getItem('chatUserId') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chatUserId', myId);

        // Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„ØºØ±ÙØ©
        window.switchRoom = function(roomName, btnElement) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            if(btnElement) {
                document.querySelectorAll('.room-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…
            document.getElementById('chatBox').innerHTML = '';
            document.getElementById('roomTitle').innerText = 'Ø§Ù„ØºØ±ÙØ©: ' + (roomName === 'general' ? 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : roomName);

            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØºØ±ÙØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¯Ø§Ø®Ù„) - Ù‡Ù†Ø§ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø´ÙƒÙ„ Ø¨Ø³ÙŠØ· Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ù‚ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
            // Ù„ÙƒÙ† Ù„Ø¬Ø¹Ù„Ù‡ Ø³Ù„Ø³ØŒ Ø³Ù†ØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©:
            currentRoom = roomName;
            
            // Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø¨Ø³Ø· Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ† Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØºØ±ÙØ© Ù‡Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©ØŒ 
            // Ù„ÙƒÙ† Ù‡Ù†Ø§ Ø³Ø£Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© JavaScript Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©:
            off(messagesRef); // ÙˆÙ‚Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù‚Ø¯ÙŠÙ…
            messagesRef = ref(db, 'rooms/' + roomName + '/messages'); // Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯
            listenForMessages(); // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¬Ø¯ÙŠØ¯
        }

        function listenForMessages() {
            onChildAdded(messagesRef, (snapshot) => {
                const msg = snapshot.val();
                const chatBox = document.getElementById("chatBox");
                
                const row = document.createElement("div");
                const isMine = msg.senderId === myId;
                row.className = isMine ? "message-row mine" : "message-row theirs";

                // ØµÙˆØ± Ø±Ù…Ø²ÙŠØ© Ù…Ø®ØªÙ„ÙØ©
                const avatarUrl = isMine 
                    ? "https://cdn-icons-png.flaticon.com/512/4140/4140047.png" // ØµÙˆØ±Ø© Ø¨Ù†Øª 1
                    : "https://cdn-icons-png.flaticon.com/512/4140/4140051.png"; // ØµÙˆØ±Ø© Ø¨Ù†Øª 2

                row.innerHTML = `
                    <div class="msg-content">${msg.text}</div>
                    <div class="msg-avatar" style="background-image: url('${avatarUrl}')"></div>
                `;

                chatBox.appendChild(row);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
        listenForMessages();

        window.sendMsg = function() {
            const input = document.getElementById("msgInput");
            const text = input.value;
            if (text.trim() !== "") {
                push(messagesRef, { text: text, senderId: myId, timestamp: Date.now() });
                input.value = "";
            }
        }

        window.handleEnter = function(e) { if(e.key === 'Enter') sendMsg(); }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø®Ø§ØµØ©
        window.openPrivateModal = function() { document.getElementById('privateModal').style.display = 'flex'; }
        window.closeModal = function() { document.getElementById('privateModal').style.display = 'none'; }
        
        window.joinPrivateRoom = function() {
            const roomName = document.getElementById('privateRoomInput').value;
            if(roomName) {
                switchRoom('private_' + roomName, null);
                document.getElementById('roomTitle').innerText = 'ØºØ±ÙØ© Ø®Ø§ØµØ©: ' + roomName + ' ğŸ”’';
                closeModal();
            }
        }
    </script>
</body>
</html>
